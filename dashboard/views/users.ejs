<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Discord Bot Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/nav', { active: 'users', user: user }) %>
    
    <div class="container">
        <h1>User Management</h1>
        
        <div class="search-box">
            <form method="GET" action="/users">
                <input type="text" name="search" placeholder="Search by User ID or Name..." value="<%= search %>">
                <button type="submit" class="btn btn-primary">Search</button>
                <% if (search) { %>
                    <a href="/users" class="btn btn-secondary">Clear</a>
                <% } %>
            </form>
        </div>
        
        <div class="bulk-actions">
            <button class="btn btn-sm btn-danger" onclick="bulkBan()" id="bulkBanBtn" disabled>Ban Selected</button>
            <button class="btn btn-sm btn-success" onclick="bulkUnban()" id="bulkUnbanBtn" disabled>Unban Selected</button>
            <span id="selectedCount" class="selected-count">0 selected</span>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Level</th>
                        <th>EXP</th>
                        <th>Money</th>
                        <th>Bank</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (users.length === 0) { %>
                        <tr>
                            <td colspan="9" class="text-center">No users found</td>
                        </tr>
                    <% } else { %>
                        <% users.forEach(user => { %>
                            <tr>
                                <td><input type="checkbox" class="user-checkbox" value="<%= user.userID %>" onchange="updateBulkActions()"></td>
                                <td><%= user.userID %></td>
                                <td><%= user.name || 'Unknown' %></td>
                                <td><%= user.level %></td>
                                <td><%= user.exp %></td>
                                <td>üí∞ <%= user.money %></td>
                                <td>üè¶ <%= user.bank %></td>
                                <td>
                                    <% if (user.banned.status) { %>
                                        <span class="badge badge-danger" title="Reason: <%= user.banned.reason %>">Banned</span>
                                    <% } else { %>
                                        <span class="badge badge-success">Active</span>
                                    <% } %>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="editUser('<%= user.userID %>')">Edit</button>
                                    <% if (user.banned.status) { %>
                                        <button class="btn btn-sm btn-success" onclick="unbanUser('<%= user.userID %>')">Unban</button>
                                    <% } else { %>
                                        <button class="btn btn-sm btn-danger" onclick="banUser('<%= user.userID %>')">Ban</button>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    <% } %>
                </tbody>
            </table>
        </div>
        
        <% if (pagination.totalPages > 1) { %>
        <div class="pagination">
            <div class="pagination-info">
                Showing <%= (pagination.page - 1) * pagination.limit + 1 %>-<%= Math.min(pagination.page * pagination.limit, pagination.totalUsers) %> of <%= pagination.totalUsers %> users
            </div>
            <div class="pagination-controls">
                <% if (pagination.hasPrev) { %>
                    <a href="/users?page=1<%= search ? '&search=' + search : '' %>" class="btn btn-sm">First</a>
                    <a href="/users?page=<%= pagination.page - 1 %><%= search ? '&search=' + search : '' %>" class="btn btn-sm">Previous</a>
                <% } %>
                
                <span class="page-numbers">
                    <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
                        <% if (i === pagination.page) { %>
                            <span class="current-page"><%= i %></span>
                        <% } else { %>
                            <a href="/users?page=<%= i %><%= search ? '&search=' + search : '' %>" class="page-link"><%= i %></a>
                        <% } %>
                    <% } %>
                </span>
                
                <% if (pagination.hasNext) { %>
                    <a href="/users?page=<%= pagination.page + 1 %><%= search ? '&search=' + search : '' %>" class="btn btn-sm">Next</a>
                    <a href="/users?page=<%= pagination.totalPages %><%= search ? '&search=' + search : '' %>" class="btn btn-sm">Last</a>
                <% } %>
            </div>
        </div>
        <% } %>
    </div>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Edit User</h2>
            <form id="editForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Money</label>
                    <input type="number" id="editMoney" required>
                </div>
                <div class="form-group">
                    <label>Bank</label>
                    <input type="number" id="editBank" required>
                </div>
                <div class="form-group">
                    <label>Level</label>
                    <input type="number" id="editLevel" required>
                </div>
                <div class="form-group">
                    <label>EXP</label>
                    <input type="number" id="editExp" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>
    </div>
    
    <script>
        function editUser(userId) {
            fetch(`/users/edit/${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('editUserId').value = userId;
                        document.getElementById('editMoney').value = data.user.money;
                        document.getElementById('editBank').value = data.user.bank;
                        document.getElementById('editLevel').value = data.user.level;
                        document.getElementById('editExp').value = data.user.exp;
                        document.getElementById('editModal').style.display = 'block';
                    }
                });
        }
        
        function banUser(userId) {
            const reason = prompt('Enter ban reason:');
            if (reason !== null) {
                fetch(`/users/ban/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                });
            }
        }
        
        function unbanUser(userId) {
            if (confirm('Are you sure you want to unban this user?')) {
                fetch(`/users/unban/${userId}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message);
                        location.reload();
                    });
            }
        }
        
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = `${count} selected`;
            document.getElementById('bulkBanBtn').disabled = count === 0;
            document.getElementById('bulkUnbanBtn').disabled = count === 0;
        }
        
        function getSelectedUsers() {
            const checkboxes = document.querySelectorAll('.user-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function bulkBan() {
            const userIDs = getSelectedUsers();
            if (userIDs.length === 0) return;
            
            const reason = prompt(`Enter ban reason for ${userIDs.length} users:`);
            if (reason !== null) {
                fetch('/users/bulk-ban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userIDs, reason })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                });
            }
        }
        
        function bulkUnban() {
            const userIDs = getSelectedUsers();
            if (userIDs.length === 0) return;
            
            if (confirm(`Are you sure you want to unban ${userIDs.length} users?`)) {
                fetch('/users/bulk-unban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userIDs })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    location.reload();
                });
            }
        }
        
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const userId = document.getElementById('editUserId').value;
            const data = {
                money: document.getElementById('editMoney').value,
                bank: document.getElementById('editBank').value,
                level: document.getElementById('editLevel').value,
                exp: document.getElementById('editExp').value
            };
            
            fetch(`/users/edit/${userId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                if (data.success) {
                    location.reload();
                }
            });
        });
        
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
    <%- include('partials/footer') %>
</body>
</html>
